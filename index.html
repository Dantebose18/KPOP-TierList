<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>KPOP Tier List</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f6f7f9;
  --card:#ffffff;
  --text:#1f2937;
  --border:#e5e7eb;
  --accent: #6366f1;
}

body.dark{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#f8fafc;
  --border:#334155;
}

body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:15px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  background: var(--card);
  border-bottom: 1px solid var(--border);
}

button,input{
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background: var(--card);
  color: var(--text);
}

button{cursor:pointer; transition: opacity 0.2s;}
button:hover{ opacity: 0.8; }

.main{
  max-width:1200px;
  margin:auto;
  padding-bottom:220px;
}

.tier{
  background:var(--card);
  border-radius:14px;
  margin-bottom:18px;
  overflow: hidden;
  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

.tier-header{
  padding:12px 18px;
  color:white;
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.tier-controls{
  display:flex;
  gap:6px;
  align-items:center;
}

.cards{
  display:flex;
  gap:14px;
  padding:18px;
  flex-wrap:wrap;
  min-height:160px;
}

/* CARDS */

.card{
  width:145px;
  height:145px;
  border-radius:12px;
  background-size:cover;
  background-position:center;
  position:relative;
  cursor: pointer;
  transition: transform .2s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}

.card:hover{
  transform:scale(1.05);
  z-index:10;
}

.card.dragging{
  opacity:.4;
  cursor: grabbing;
}

/* NOUVEAU DESIGN DE L'OVERLAY */
.card-overlay {
  position: absolute;
  bottom: 0;
  width: 100%;
  padding: 25px 10px 10px 10px;
  background: linear-gradient(transparent, rgba(0,0,0,0.9));
  color: white;
  box-sizing: border-box;
  pointer-events: none; /* Laisse passer le clic vers la carte */
}

.card-overlay strong {
  display: block;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  opacity: 0.9;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-overlay span {
  display: block;
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-tools{
  position:absolute;
  top:6px;
  right:6px;
  display:flex;
  gap:6px;
  z-index: 20;
}

.card-tools button{
  background:rgba(0,0,0,.6);
  backdrop-filter: blur(4px);
  border:none;
  color:white;
  border-radius:6px;
  padding:4px 6px;
  font-size:12px;
}

/* DROP PREVIEW */

.placeholder{
  width:145px;
  height:145px;
  border-radius:12px;
  border:2px dashed var(--accent);
  background:rgba(99, 102, 241, 0.1);
}

.hidden .card-tools,
.hidden .tier-controls{
  display:none;
}

.pool-container{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:var(--bg);
  padding:14px;
  border-top:2px solid var(--border);
  box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
  z-index: 100;
}

.pool{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
  min-height:150px;
  overflow-x: auto;
}
</style>
</head>
<body>

<header>
  <button onclick="addTier()">‚ûï Nouveau Tier</button>
  <button onclick="toggleEdit()" id="editBtn">‚úèÔ∏è Mode √©dition : OFF</button>
  <button onclick="toggleDark()">üåô Dark Mode</button>
</header>

<div class="main">

<div style="display:flex;gap:10px;margin:30px 0; justify-content: center;">
  <input id="artistInput" placeholder="Artiste (ex: NewJeans)">
  <input id="titleInput" placeholder="Titre (ex: OMG)">
  <button onclick="addSong()" style="background: var(--accent); color: white; border: none;">Ajouter au Pool</button>
</div>

<div id="tiers"></div>
</div>

<div class="pool-container">
<h3 style="margin-top:0">üéµ Pool de chansons</h3>
<div id="pool" class="pool"></div>
</div>

<script>
/* ================= DATA ================= */

function defaultData(){
  return {
    tiers:[
      {id:"S",name:"S (God Tier)",color:"#ef4444",songs:[]},
      {id:"A",name:"A (Amazing)",color:"#f97316",songs:[]},
      {id:"B",name:"B (Good)",color:"#eab308",songs:[]},
      {id:"C",name:"C (Fine)",color:"#22c55e",songs:[]}
    ],
    pool:[]
  };
}

function load(){
  try{
    const raw=localStorage.getItem("tierData");
    if(!raw) return defaultData();
    const parsed=JSON.parse(raw);
    if(parsed?.tiers && parsed?.pool) return parsed;
  }catch(e){}
  return defaultData();
}

function save(){
  localStorage.setItem("tierData",JSON.stringify(data));
}

let data=load();
let editMode=false;
let draggedId=null;
let placeholder=null;
let isDraggingAction = false; // Pour √©viter d'ouvrir YouTube en glissant

/* ================= RENDER ================= */

function render(){
  const tiersDiv=document.getElementById("tiers");
  tiersDiv.innerHTML="";

  data.tiers.forEach(t=>{
    const tier=document.createElement("div");
    tier.className="tier";

    const header=document.createElement("div");
    header.className="tier-header";
    header.style.background=t.color;

    const title=document.createElement("span");
    title.textContent=t.name;

    const controls=document.createElement("div");
    controls.className="tier-controls";

    const colorInput=document.createElement("input");
    colorInput.type="color";
    colorInput.value=t.color;
    colorInput.style.width="30px";
    colorInput.style.padding="0";
    colorInput.oninput=e=>{
      t.color=e.target.value;
      save();
      render();
    };

    const renameBtn=document.createElement("button");
    renameBtn.textContent="‚úèÔ∏è";
    renameBtn.onclick=()=>{
      const n=prompt("Nouveau nom :",t.name);
      if(n){ t.name=n; save(); render(); }
    };

    const delBtn=document.createElement("button");
    delBtn.textContent="üóëÔ∏è";
    delBtn.onclick=()=>{
      if(confirm("Supprimer cette cat√©gorie ?")){
        data.pool.push(...t.songs);
        data.tiers=data.tiers.filter(x=>x.id!==t.id);
        save();
        render();
      }
    };

    controls.append(colorInput,renameBtn,delBtn);
    header.append(title,controls);

    const container=document.createElement("div");
    container.className="cards";

    setupDrop(container,t.id);

    t.songs.forEach(song=>{
      container.appendChild(createCard(song));
    });

    tier.append(header,container);
    tiersDiv.appendChild(tier);
  });

  const pool=document.getElementById("pool");
  pool.innerHTML="";
  setupDrop(pool,null);

  data.pool.forEach(song=>{
    pool.appendChild(createCard(song));
  });

  document.body.classList.toggle("hidden",!editMode);
}

/* ================= CARD ================= */

function createCard(song){
  const card=document.createElement("div");
  card.className="card";
  card.draggable=true;
  card.dataset.id=song.id;
  card.style.backgroundImage=`url(${song.cover||""})`;

  // Lien YouTube au clic
  card.onclick = (e) => {
    // Si on clique sur les boutons d'√©dition ou si on finit un drag, on n'ouvre pas
    if(e.target.tagName === 'BUTTON' || isDraggingAction) return;
    if(song.youtubeUrl) window.open(song.youtubeUrl, '_blank');
  };

  card.addEventListener("dragstart",()=>{
    draggedId=song.id;
    isDraggingAction = true;
    card.classList.add("dragging");
  });

  card.addEventListener("dragend",()=>{
    card.classList.remove("dragging");
    if(placeholder) placeholder.remove();
    // Petit d√©lai pour ne pas d√©clencher le onclick imm√©diatement apr√®s le drop
    setTimeout(() => { isDraggingAction = false; }, 100);
  });

  const overlay=document.createElement("div");
  overlay.className="card-overlay";
  overlay.innerHTML=`<strong>${song.artist}</strong><span>${song.title}</span>`;

  const tools=document.createElement("div");
  tools.className="card-tools";

  const editBtn=document.createElement("button");
  editBtn.textContent="‚úèÔ∏è";
  editBtn.onclick=(e)=>{
    e.stopPropagation();
    const a=prompt("Artiste :",song.artist);
    const t=prompt("Titre :",song.title);
    if(a!==null && t!==null){
      song.artist=a.trim();
      song.title=t.trim();
      song.youtubeUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(song.artist + " " + song.title)}`;
      save();
      render();
    }
  };

  const delBtn=document.createElement("button");
  delBtn.textContent="üóëÔ∏è";
  delBtn.onclick=(e)=>{
    e.stopPropagation();
    removeSong(song.id);
  };

  tools.append(editBtn,delBtn);
  card.append(overlay,tools);

  return card;
}

/* ================= DRAG SYSTEM ================= */

function setupDrop(container,tierId){
  container.addEventListener("dragover",e=>{
    e.preventDefault();
    const after=getDragAfterElement(container,e.clientX);
    if(!placeholder){
      placeholder=document.createElement("div");
      placeholder.className="placeholder";
    }
    if(after==null) container.appendChild(placeholder);
    else container.insertBefore(placeholder,after);
  });

  container.addEventListener("drop",()=>{
    if(!draggedId) return;
    const song=findSong(draggedId);
    removeSong(draggedId);

    const index=[...container.children].indexOf(placeholder);

    if(tierId){
      const tier=data.tiers.find(t=>t.id===tierId);
      tier.songs.splice(index,0,song);
    }else{
      data.pool.splice(index,0,song);
    }

    placeholder.remove();
    save();
    render();
  });
}

function getDragAfterElement(container,x){
  const els=[...container.querySelectorAll(".card:not(.dragging)")];
  
  return els.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = x - box.left - box.width / 2; // Calcul bas√© sur le centre de la carte
    
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: -Infinity }).element;
}

/* ================= LOGIC ================= */

function removeSong(id){
  data.pool=data.pool.filter(s=>s.id!==id);
  data.tiers.forEach(t=>{
    t.songs=t.songs.filter(s=>s.id!==id);
  });
  save();
  render();
}

function findSong(id){
  return [...data.pool,...data.tiers.flatMap(t=>t.songs)]
    .find(s=>s.id===id);
}

/* ================= ACTIONS ================= */

async function addSong(){
  const artist=document.getElementById("artistInput").value.trim();
  const title=document.getElementById("titleInput").value.trim();
  if(!artist||!title) return;

  const id=Date.now().toString()+Math.random().toString(16).slice(2);

  let cover="";
  try{
    const res=await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(title+" "+artist)}&entity=song&limit=1`);
    const json=await res.json();
    cover=json.results[0]?.artworkUrl100?.replace("100x100","300x300")||"";
  }catch(e){}

  // Lien YouTube automatique
  const youtubeUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(artist + " " + title)}`;

  data.pool.push({id,artist,title,cover,youtubeUrl});
  save();
  render();

  document.getElementById("artistInput").value="";
  document.getElementById("titleInput").value="";
}

function addTier(){
  const name=prompt("Nom du tier ?");
  if(!name) return;
  data.tiers.push({
    id:Date.now().toString(),
    name,
    color:"#6366f1",
    songs:[]
  });
  save();
  render();
}

function toggleEdit(){
  editMode=!editMode;
  document.getElementById("editBtn").textContent=
    editMode?"‚úèÔ∏è Mode √©dition : ON":"‚úèÔ∏è Mode √©dition : OFF";
  render();
}

function toggleDark(){
  document.body.classList.toggle("dark");
}

render();
</script>
</body>
</html>
