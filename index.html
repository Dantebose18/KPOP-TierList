<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>KPOP Tier List Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f0f2f5;
  --card:#ffffff;
  --text:#1f2937;
  --border:#e5e7eb;
  --accent: #6366f1;
  --hover-glow: rgba(99, 102, 241, 0.6);
}

body.dark{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#f8fafc;
  --border:#334155;
  --hover-glow: rgba(139, 92, 246, 0.8);
}

body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  transition: background 0.3s ease;
}

header{
  padding:15px 25px;
  display:flex;
  gap:12px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  align-items: center;
}

button,input{
  padding:10px 16px;
  border-radius:10px;
  border:1px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-weight: 500;
  transition: all 0.2s;
}

button{cursor:pointer;}
button:hover{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

.main{
  max-width:1300px;
  margin:auto;
  padding: 20px;
  padding-bottom:250px;
}

.tier{
  background:var(--card);
  border-radius:16px;
  margin-bottom:25px;
  overflow: hidden;
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
}

.tier-header{
  padding:15px 20px;
  color:white;
  font-weight:800;
  display:flex;
  justify-content:space-between;
  align-items:center;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.cards{
  display:flex;
  gap:18px;
  padding:20px;
  flex-wrap:wrap;
  min-height:160px;
}

/* CARDS REDESIGN */

.card{
  width:145px;
  height:145px;
  border-radius:14px;
  background-size:cover;
  background-position:center;
  position:relative;
  cursor: pointer;
  transition: transform .25s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.25s ease;
  overflow: hidden;
}

/* EFFET HOVER AGGRANDI + GLOW */
.card:hover{
  transform: scale(1.3);
  z-index: 100;
  box-shadow: 0 0 20px 5px var(--hover-glow), 0 10px 20px rgba(0,0,0,0.3);
  outline: 2px solid white;
}

.card.dragging{
  opacity:0.2;
}

.card-overlay {
  position: absolute;
  bottom: 0;
  width: 100%;
  padding: 30px 10px 10px 10px;
  background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
  color: white;
  box-sizing: border-box;
}

.card-overlay strong {
  display: block;
  font-size: 10px;
  opacity: 0.8;
  text-transform: uppercase;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-overlay span {
  display: block;
  font-size: 12px;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-tools{
  position:absolute;
  top:8px;
  right:8px;
  display:flex;
  gap:5px;
  opacity: 0;
  transition: opacity 0.2s;
}

.card:hover .card-tools{ opacity: 1; }

.card-tools button{
  background:rgba(255,255,255,0.9);
  border:none;
  color:#000;
  border-radius:8px;
  padding:5px;
  font-size:10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* PLACEHOLDER */

.placeholder{
  width:145px;
  height:145px;
  border-radius:14px;
  border: 3px dashed var(--accent);
  background: rgba(99, 102, 241, 0.1);
  box-sizing: border-box;
}

.hidden .card-tools, .hidden .tier-controls{ display:none; }

.pool-container{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:var(--card);
  padding:15px 30px;
  border-top:1px solid var(--border);
  box-shadow: 0 -10px 25px rgba(0,0,0,0.05);
  z-index: 1000;
}

.pool{
  display:flex;
  gap:15px;
  flex-wrap:nowrap;
  overflow-x: auto;
  min-height:165px;
  padding: 5px 0;
}
</style>
</head>
<body>

<header>
  <div style="font-size: 20px; margin-right: 20px;">üåü <b>K-Tier</b></div>
  <button onclick="addTier()">‚ûï Nouveau Tier</button>
  <button onclick="toggleEdit()" id="editBtn">‚úèÔ∏è Mode √©dition : OFF</button>
  <button onclick="toggleDark()">üåô</button>
</header>

<div class="main">
  <div style="display:flex;gap:10px;margin:20px 0; justify-content: center; background: var(--card); padding: 20px; border-radius: 15px;">
    <input id="artistInput" placeholder="Artiste">
    <input id="titleInput" placeholder="Musique">
    <button onclick="addSong()" style="background: var(--accent); color: white; border: none; padding: 10px 25px;">Ajouter</button>
  </div>
  <div id="tiers"></div>
</div>

<div class="pool-container">
  <h3 style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.6;">POOL ATTENTE</h3>
  <div id="pool" class="pool"></div>
</div>

<script>
/* ================= DATA ================= */
let data = load();
let editMode = false;
let draggedId = null;
let placeholder = document.createElement("div");
placeholder.className = "placeholder";

function defaultData(){
  return {
    tiers:[
      {id:"S",name:"S - Legends",color:"#ff4b2b",songs:[]},
      {id:"A",name:"A - Top",color:"#ff8c00",songs:[]},
      {id:"B",name:"B - Good",color:"#ffd700",songs:[]}
    ],
    pool:[]
  };
}

function load(){
  const raw = localStorage.getItem("tierDataV2");
  return raw ? JSON.parse(raw) : defaultData();
}

function save(){
  localStorage.setItem("tierDataV2", JSON.stringify(data));
}

/* ================= RENDER ================= */

function render(){
  const tiersDiv = document.getElementById("tiers");
  tiersDiv.innerHTML = "";

  data.tiers.forEach(t => {
    const tier = document.createElement("div");
    tier.className = "tier";

    const header = document.createElement("div");
    header.className = "tier-header";
    header.style.background = t.color;
    header.innerHTML = `<span>${t.name}</span>`;

    const controls = document.createElement("div");
    controls.className = "tier-controls";
    
    // Boutons de gestion
    controls.innerHTML = `
      <input type="color" value="${t.color}" oninput="updateTierColor('${t.id}', this.value)" style="width:30px; height:30px; border:none; background:none; padding:0; cursor:pointer">
      <button onclick="renameTier('${t.id}')">‚úèÔ∏è</button>
      <button onclick="deleteTier('${t.id}')">üóëÔ∏è</button>
    `;
    header.appendChild(controls);

    const container = document.createElement("div");
    container.className = "cards";
    setupDrop(container, t.id);

    t.songs.forEach(song => container.appendChild(createCard(song)));
    
    tier.append(header, container);
    tiersDiv.appendChild(tier);
  });

  const pool = document.getElementById("pool");
  pool.innerHTML = "";
  setupDrop(pool, null);
  data.pool.forEach(song => pool.appendChild(createCard(song)));

  document.body.classList.toggle("hidden", !editMode);
}

/* ================= CARD ================= */

function createCard(song){
  const card = document.createElement("div");
  card.className = "card";
  card.draggable = true;
  card.style.backgroundImage = `url(${song.cover})`;

  card.onclick = () => { if(!editMode) window.open(song.youtubeUrl, '_blank'); };

  card.ondragstart = () => {
    draggedId = song.id;
    setTimeout(() => card.classList.add("dragging"), 0);
  };

  card.ondragend = () => {
    card.classList.remove("dragging");
    placeholder.remove();
  };

  card.innerHTML = `
    <div class="card-overlay">
      <strong>${song.artist}</strong>
      <span>${song.title}</span>
    </div>
    <div class="card-tools">
      <button onclick="event.stopPropagation(); deleteSong('${song.id}')">üóëÔ∏è</button>
    </div>
  `;

  return card;
}

/* ================= DRAG LOGIC (FIXED) ================= */

function setupDrop(container, tierId){
  container.ondragover = e => {
    e.preventDefault();
    const afterElement = getDragAfterElement(container, e.clientX);
    if (afterElement == null) {
      container.appendChild(placeholder);
    } else {
      container.insertBefore(placeholder, afterElement);
    }
  };

  container.ondrop = e => {
    e.preventDefault();
    const song = findAndRemoveSong(draggedId);
    if(!song) return;

    // Calcul de l'index r√©el sans le placeholder
    const children = [...container.querySelectorAll('.card:not(.dragging)')];
    const index = children.indexOf(placeholder.nextElementSibling);
    const finalIndex = index === -1 ? children.length : index;

    if(tierId){
      data.tiers.find(t => t.id === tierId).songs.splice(finalIndex, 0, song);
    } else {
      data.pool.splice(finalIndex, 0, song);
    }

    save();
    render();
  };
}

function getDragAfterElement(container, x) {
  const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];

  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = x - box.left - box.width / 2;
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: -Infinity }).element;
}

/* ================= ACTIONS ================= */

async function addSong(){
  const artist = document.getElementById("artistInput").value.trim();
  const title = document.getElementById("titleInput").value.trim();
  if(!artist || !title) return;

  let cover = "https://via.placeholder.com/300";
  try {
    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artist + " " + title)}&entity=song&limit=1`);
    const json = await res.json();
    if(json.results[0]) cover = json.results[0].artworkUrl100.replace("100x100", "400x400");
  } catch(e) {}

  // Lien YouTube Direct (Recherche du clip officiel)
  const ytQuery = encodeURIComponent(artist + " " + title + " official mv");
  const youtubeUrl = `https://www.youtube.com/results?search_query=${ytQuery}`;

  data.pool.push({ id: Date.now().toString(), artist, title, cover, youtubeUrl });
  save();
  render();
  document.getElementById("artistInput").value = "";
  document.getElementById("titleInput").value = "";
}

function findAndRemoveSong(id){
  let found = null;
  data.pool = data.pool.filter(s => { if(s.id === id) found = s; return s.id !== id; });
  data.tiers.forEach(t => {
    t.songs = t.songs.filter(s => { if(s.id === id) found = s; return s.id !== id; });
  });
  return found;
}

function updateTierColor(id, color){
  data.tiers.find(t => t.id === id).color = color;
  save();
  render();
}

function renameTier(id){
  const n = prompt("Nom :");
  if(n) { data.tiers.find(t => t.id === id).name = n; save(); render(); }
}

function deleteTier(id){
  if(confirm("Supprimer?")) {
    const t = data.tiers.find(x => x.id === id);
    data.pool.push(...t.songs);
    data.tiers = data.tiers.filter(x => x.id !== id);
    save(); render();
  }
}

function deleteSong(id){
  findAndRemoveSong(id);
  save(); render();
}

function addTier(){
  const name = prompt("Nom ?");
  if(name) { data.tiers.push({id: Date.now().toString(), name, color: "#6366f1", songs: []}); save(); render(); }
}

function toggleEdit(){
  editMode = !editMode;
  document.getElementById("editBtn").textContent = editMode ? "‚úèÔ∏è Mode √©dition : ON" : "‚úèÔ∏è Mode √©dition : OFF";
  render();
}

function toggleDark(){ document.body.classList.toggle("dark"); }

render();
</script>
</body>
</html>
