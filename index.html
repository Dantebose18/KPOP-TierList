<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Music Tier List</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f6f7f9;
  --card:#ffffff;
  --text:#1f2937;
  --border:#e5e7eb;
}

body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:20px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
}

button,input{
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--border);
}

button{cursor:pointer}
button.primary{background:#111;color:white;border:none}

.main{
  max-width:1300px;
  margin:auto;
  padding-bottom:220px;
}

/* Titre modifiable */
.tierlist-title{
  font-size:26px;
  font-weight:600;
  margin:20px 0;
  border:none;
  background:transparent;
}

/* TIERS */
.tier{
  background:var(--card);
  border-radius:16px;
  margin-bottom:18px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.tier-header{
  padding:10px;
  color:white;
  display:flex;
  gap:10px;
  align-items:center;
  border-radius:16px 16px 0 0;
}

.cards{
  display:flex;
  gap:14px;
  padding:14px;
  flex-wrap:wrap;
  min-height:140px;
}

/* CARTES */
.card{
  width:140px;
  height:140px;
  border-radius:16px;
  background-size:cover;
  background-position:center;
  position:relative;
  cursor:grab;
  transition:transform .2s ease, box-shadow .2s ease;
}

.card:hover{
  transform:scale(1.7);
  z-index:50;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}

.card.dragging{
  opacity:0.4;
}

.card-overlay{
  position:absolute;
  bottom:0;
  width:100%;
  padding:6px;
  background:linear-gradient(to top,rgba(0,0,0,.8),transparent);
  color:white;
  font-size:12px;
  border-radius:0 0 16px 16px;
}

.card-tools{
  position:absolute;
  top:6px;
  left:6px;
  display:flex;
  gap:6px;
}

.card-tools button{
  background:rgba(0,0,0,.6);
  color:white;
  border:none;
  border-radius:6px;
  padding:3px 6px;
  font-size:12px;
}

.hidden-tools .card-tools{
  display:none;
}

/* POOL FIXE */
.pool-container{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:white;
  padding:14px;
  border-top:2px solid var(--border);
  box-shadow:0 -6px 20px rgba(0,0,0,0.08);
}

.pool{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
  min-height:140px;
}
</style>
</head>
<body>

<header>
  <button onclick="addTier()">‚ûï Tier</button>
  <button onclick="toggleEditMode()" id="editToggle">‚úèÔ∏è Mode √©dition : ON</button>
</header>

<div class="main">
<input id="tierListTitle" class="tierlist-title">

<div style="display:flex;gap:10px;margin-bottom:20px;">
  <input id="artistInput" placeholder="Artiste">
  <input id="titleInput" placeholder="Titre">
  <button class="primary" onclick="addSong()">Ajouter</button>
</div>

<div id="tiers"></div>
</div>

<div class="pool-container">
<h3>üéµ Pool</h3>
<div id="pool" class="pool"></div>
</div>

<script>
let tierList={
  name:"Ma Tier List",
  tiers:[
    {id:"S",name:"S",color:"#ef4444",songs:[]},
    {id:"A",name:"A",color:"#22c55e",songs:[]},
    {id:"B",name:"B",color:"#eab308",songs:[]},
    {id:"C",name:"C",color:"#9ca3af",songs:[]}
  ],
  pool:[]
};

let dragged=null;
let editMode=true;

/* SAVE */
function save(){
  localStorage.setItem("tierList",JSON.stringify(tierList));
}

function load(){
  const saved=localStorage.getItem("tierList");
  if(saved) tierList=JSON.parse(saved);
}

load();

/* RENDER */
function render(){
  document.getElementById("tierListTitle").value=tierList.name;

  const tiersDiv=document.getElementById("tiers");
  tiersDiv.innerHTML="";

  tierList.tiers.forEach(t=>{
    const tier=document.createElement("div");
    tier.className="tier";

    const header=document.createElement("div");
    header.className="tier-header";
    header.style.background=t.color;
    header.innerHTML=`<strong>${t.name}</strong>`;

    const cards=document.createElement("div");
    cards.className="cards";
    setupDragContainer(cards,t);

    t.songs.forEach(s=>cards.appendChild(createCard(s)));

    tier.append(header,cards);
    tiersDiv.appendChild(tier);
  });

  const pool=document.getElementById("pool");
  pool.innerHTML="";
  setupDragContainer(pool,null);
  tierList.pool.forEach(s=>pool.appendChild(createCard(s)));
}

/* CREATE CARD */
function createCard(song){
  const card=document.createElement("div");
  card.className="card";
  card.draggable=true;
  card.dataset.id=song.id;
  card.style.backgroundImage=`url(${song.cover||''})`;

  card.addEventListener("dragstart",()=>{
    dragged=song;
    card.classList.add("dragging");
  });

  card.addEventListener("dragend",()=>{
    card.classList.remove("dragging");
    dragged=null;
  });

  const overlay=document.createElement("div");
  overlay.className="card-overlay";
  overlay.innerHTML=`<strong>${song.artist}</strong><br>${song.title}`;

  const tools=document.createElement("div");
  tools.className="card-tools";

  const editBtn=document.createElement("button");
  editBtn.innerHTML="‚úèÔ∏è";
  editBtn.onclick=()=>{
    overlay.innerHTML=`
      <div contenteditable="true">${song.artist}</div>
      <div contenteditable="true">${song.title}</div>
    `;
    overlay.querySelectorAll("div").forEach((el,i)=>{
      el.onblur=()=>{
        if(i===0) song.artist=el.innerText;
        else song.title=el.innerText;
        save();
        render();
      };
    });
  };

  const delBtn=document.createElement("button");
  delBtn.innerHTML="üóëÔ∏è";
  delBtn.onclick=()=>deleteSong(song.id);

  tools.append(editBtn,delBtn);
  card.append(overlay,tools);
  return card;
}

/* DRAG CONTAINER */
function setupDragContainer(container,tier){
  container.addEventListener("dragover",e=>{
    e.preventDefault();
    const after=getAfterElement(container,e.clientX);
    const draggable=document.querySelector(".dragging");
    if(!draggable) return;

    if(after==null) container.appendChild(draggable);
    else container.insertBefore(draggable,after);
  });

  container.addEventListener("drop",()=>{
    if(!dragged) return;

    tierList.pool=tierList.pool.filter(s=>s!==dragged);
    tierList.tiers.forEach(t=>t.songs=t.songs.filter(s=>s!==dragged));

    const order=[...container.querySelectorAll(".card")]
      .map(c=>findSong(c.dataset.id));

    if(tier) tier.songs=order;
    else tierList.pool=order;

    save();
  });
}

function getAfterElement(container,x){
  const els=[...container.querySelectorAll(".card:not(.dragging)")];
  return els.reduce((closest,child)=>{
    const box=child.getBoundingClientRect();
    const offset=x-box.left-box.width/2;
    if(offset<0 && offset>closest.offset){
      return {offset:offset,element:child};
    }else return closest;
  },{offset:Number.NEGATIVE_INFINITY}).element;
}

function findSong(id){
  return [...tierList.pool,...tierList.tiers.flatMap(t=>t.songs)]
    .find(s=>s.id==id);
}

/* ACTIONS */
async function addSong(){
  const artist=document.getElementById("artistInput").value.trim();
  const title=document.getElementById("titleInput").value.trim();
  if(!artist||!title) return;

  const res=await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(title+" "+artist)}&entity=song&limit=1`);
  const data=await res.json();
  const cover=data.results[0]?.artworkUrl100?.replace("100x100","300x300")||"";

  tierList.pool.push({
    id:Date.now()+Math.random(),
    artist,title,cover
  });

  save();
  render();
}

function deleteSong(id){
  tierList.pool=tierList.pool.filter(s=>s.id!==id);
  tierList.tiers.forEach(t=>t.songs=t.songs.filter(s=>s.id!==id));
  save();
  render();
}

function addTier(){
  const name=prompt("Nom du tier ?");
  if(!name) return;
  tierList.tiers.push({id:Date.now(),name,color:"#3b82f6",songs:[]});
  save();
  render();
}

function toggleEditMode(){
  editMode=!editMode;
  document.body.classList.toggle("hidden-tools",!editMode);
  document.getElementById("editToggle").textContent=
    editMode?"‚úèÔ∏è Mode √©dition : ON":"‚úèÔ∏è Mode √©dition : OFF";
}

document.getElementById("tierListTitle").oninput=e=>{
  tierList.name=e.target.value;
  save();
};

render();
</script>
</body>
</html>
